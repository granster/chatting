<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBz4pGNNkQa3cKN4WhO3OA7a_M33CJqYU8",
    authDomain: "chatting-f4972.firebaseapp.com",
    databaseURL: "https://chatting-f4972-default-rtdb.firebaseio.com",
    projectId: "chatting-f4972",
    storageBucket: "chatting-f4972.appspot.com",
    messagingSenderId: "174118082802",
    appId: "1:174118082802:web:38f8d521f24a9d3f88d86b",
    measurementId: "G-X6CJ742JJD"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const socket = io();
  const form = document.getElementById('form');
  const input = document.getElementById('input');
  const messages = document.getElementById('messages');

  let isAdmin = false;
  const seenMessages = new Set();

  function appendMessage(msg, id) {
    const timestamp = msg.timestamp || Date.now();
    if (!id) id = `${msg.text}-${msg.ip || 'x'}-${timestamp}`;
    if (seenMessages.has(id)) return;
    seenMessages.add(id);

    const item = document.createElement('li');
    item.className = 'message';

    let display = msg.text;

    if (isAdmin) {
      if (msg.ip) display += ` (${msg.ip})`;
      if (msg.timestamp) {
        const time = new Date(msg.timestamp).toLocaleTimeString([], {
          hour: '2-digit',
          minute: '2-digit'
        });
        display += ` @ ${time}`;
      }
    }

    item.textContent = display;
    messages.appendChild(item);
    messages.scrollTop = messages.scrollHeight;
  }

  function loadHistory() {
    db.ref('messages').limitToLast(100).once('value', snapshot => {
      const data = snapshot.val();
      if (data) {
        Object.entries(data).forEach(([key, msg]) => appendMessage(msg, key));
      }
    });
  }

  loadHistory();

  socket.on('chat message', (msg) => {
    appendMessage(msg);
  });

  socket.on('admin confirmed', () => {
    isAdmin = true;
    alert("âœ… Admin mode activated");
    seenMessages.clear();
    messages.innerHTML = '';
    loadHistory();
  });

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;

    if (text.startsWith("/admin ")) {
      const token = text.split(" ")[1];
      socket.emit("admin login", token);
    } else {
      socket.emit("chat message", text);
    }

    input.value = '';
  });
</script>
